trigger:
  branches:
    include:
      - main
jobs:
- job: BuildAndDeploy
pool:
  vmImage: 'ubuntu-latest'
steps:
  - task: Docker@2
    displayName: 'Build and push dockerApi image'
    inputs:
      command: 'buildAndPush'
      Dockerfile: '$(Build.SourcesDirectory)/dockerApi/Dockerfile'
      imageName: 'myacr.azurecr.io/app1:$(Build.BuildId)'
      containerRegistry: 'myacr'

  - task: Docker@2
    displayName: 'Build and push dockerApp image'
    inputs:
      command: 'buildAndPush'
      Dockerfile: '$(Build.SourcesDirectory)/dockerApp/Dockerfile'
      imageName: 'myacr.azurecr.io/app2:$(Build.BuildId)'
      containerRegistry: 'myacr'

  - script: |
      az container create --resource-group myResourceGroup --name multiContainerGroup --image myacr.azurecr.io/app1:$(Build.BuildId) myacr.azurecr.io/app2:$(Build.BuildId) --registry-login-server myacr.azurecr.io --registry-username $(ACR_USERNAME) --registry-password $(ACR_PASSWORD)
    displayName: 'Deploy multi-container group'
